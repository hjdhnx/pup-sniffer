# Pup Sniffer - Golang ç‰ˆæœ¬

åŸºäº [go-rod](https://github.com/go-rod/rod) çš„è§†é¢‘èµ„æºå—…æ¢å™¨ Golang å®ç°ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¯ **åª’ä½“å—…æ¢**: è‡ªåŠ¨æ£€æµ‹å’Œæå–ç½‘é¡µä¸­çš„è§†é¢‘/éŸ³é¢‘èµ„æº URL
- ğŸŒ **å¤šæ¨¡å¼æ”¯æŒ**: æ”¯æŒå•ä¸ª URL å—…æ¢å’Œæ‰¹é‡ URL æ”¶é›†
- ğŸ“± **è®¾å¤‡æ¨¡æ‹Ÿ**: æ”¯æŒ PC å’Œç§»åŠ¨è®¾å¤‡æ¨¡æ‹Ÿ
- ğŸ”§ **è‡ªå®šä¹‰è„šæœ¬**: æ”¯æŒé¡µé¢åˆå§‹åŒ–è„šæœ¬å’Œæ‰§è¡Œè„šæœ¬
- ğŸ“„ **é¡µé¢æºç **: è·å–åŠ¨æ€æ¸²æŸ“åçš„é¡µé¢ HTML æºç 
- âš¡ **é«˜æ€§èƒ½**: åŸºäº Chrome DevTools Protocolï¼Œæ€§èƒ½ä¼˜å¼‚
- ğŸ›¡ï¸ **åæ£€æµ‹**: å†…ç½®åè‡ªåŠ¨åŒ–æ£€æµ‹æœºåˆ¶

## ç³»ç»Ÿè¦æ±‚

- Go >= 1.21
- Chrome æµè§ˆå™¨ (ç”¨äº go-rod)
- æ”¯æŒ Windowsã€Linuxã€macOS

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd golang
go mod tidy
```

### 2. è¿è¡ŒæœåŠ¡

```bash
# ä½¿ç”¨é»˜è®¤ç«¯å£ (è‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨ç«¯å£ï¼Œä» 57573 å¼€å§‹)
go run .

# æŒ‡å®šç«¯å£
go run . -port 8080

# æŸ¥çœ‹å¸®åŠ©
go run . -help
```

### 3. ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶

```bash
# ç¼–è¯‘å½“å‰å¹³å°
go build -o pup-sniffer .

# äº¤å‰ç¼–è¯‘ Windows
GOOS=windows GOARCH=amd64 go build -o pup-sniffer.exe .

# äº¤å‰ç¼–è¯‘ Linux
GOOS=linux GOARCH=amd64 go build -o pup-sniffer-linux .
```

## API æ¥å£

### 1. åª’ä½“å—…æ¢æ¥å£

**GET** `/sniffer`

**å‚æ•°:**
- `url` (å¿…éœ€): ç›®æ ‡é¡µé¢ URL
- `mode` (å¯é€‰): å—…æ¢æ¨¡å¼
  - `0`: å•ä¸ª URL æ¨¡å¼ (æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„ URL åç«‹å³è¿”å›)
  - `1`: æ‰¹é‡ URL æ¨¡å¼ (æ”¶é›†æ‰€æœ‰åŒ¹é…çš„ URL)
- `is_pc` (å¯é€‰): è®¾å¤‡æ¨¡å¼
  - `0`: ç§»åŠ¨è®¾å¤‡æ¨¡æ‹Ÿ (é»˜è®¤)
  - `1`: PC è®¾å¤‡æ¨¡æ‹Ÿ
- `timeout` (å¯é€‰): è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ (é»˜è®¤: 10000ï¼Œæœ€å¤§: 60000)
- `custom_regex` (å¯é€‰): è‡ªå®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
- `sniffer_exclude` (å¯é€‰): æ’é™¤æ­£åˆ™è¡¨è¾¾å¼
- `css` (å¯é€‰): CSS é€‰æ‹©å™¨ï¼Œç­‰å¾…å…ƒç´ å‡ºç°
- `script` (å¯é€‰): é¡µé¢è„šæœ¬ (Base64 ç¼–ç )
- `init_script` (å¯é€‰): åˆå§‹åŒ–è„šæœ¬ (Base64 ç¼–ç )
- `headers` (å¯é€‰): è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œæ ¼å¼ä¸º "key: value" æ¯è¡Œä¸€ä¸ª

**ç¤ºä¾‹:**
```bash
curl "http://localhost:57573/sniffer?url=https://example.com&mode=0&timeout=10000"
```

### 2. é¡µé¢æºç æ¥å£

**GET** `/fetCodeByWebView`

è·å–åŠ¨æ€æ¸²æŸ“åçš„é¡µé¢ HTML æºç ã€‚

**å‚æ•°:** ä¸å—…æ¢æ¥å£ç›¸åŒ (é™¤äº† `mode`, `custom_regex`, `sniffer_exclude`)

**ç¤ºä¾‹:**
```bash
curl "http://localhost:57573/fetCodeByWebView?url=https://example.com&timeout=10000"
```

### 3. å¥åº·æ£€æŸ¥æ¥å£

**GET** `/health`

æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚

### 4. æ´»è·ƒçŠ¶æ€æ¥å£

**GET** `/active`

æ£€æŸ¥æœåŠ¡å’Œæµè§ˆå™¨çŠ¶æ€ã€‚

## å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£éƒ½è¿”å›ç»Ÿä¸€çš„ JSON æ ¼å¼ï¼š

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    // å…·ä½“æ•°æ®
  },
  "timestamp": 1640995200000
}
```

### å—…æ¢æˆåŠŸå“åº” (mode=0)

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "url": "https://example.com/video.m3u8",
    "headers": {
      "referer": "https://example.com",
      "user-agent": "Mozilla/5.0..."
    },
    "from": "https://example.com",
    "cost": "2500 ms",
    "total_cost": "2600 ms",
    "code": 200,
    "msg": "è¶…çº§å—…æ¢è§£ææˆåŠŸ"
  }
}
```

### å—…æ¢æˆåŠŸå“åº” (mode=1)

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "urls": [
      {
        "url": "https://example.com/video1.m3u8",
        "headers": {
          "referer": "https://example.com"
        }
      },
      {
        "url": "https://example.com/video2.mp4",
        "headers": {
          "referer": "https://example.com"
        }
      }
    ],
    "from": "https://example.com",
    "cost": "5000 ms",
    "total_cost": "5100 ms",
    "code": 200,
    "msg": "è¶…çº§å—…æ¢è§£ææˆåŠŸ"
  }
}
```

## é…ç½®è¯´æ˜

### é»˜è®¤é…ç½®

```go
config := &SnifferConfig{
    Debug:          true,     // å¯ç”¨è°ƒè¯•æ—¥å¿—
    Headless:       true,     // æ— å¤´æ¨¡å¼
    UseChrome:      true,     // ä½¿ç”¨ç³»ç»Ÿ Chrome
    DeviceType:     "mobile", // é»˜è®¤ç§»åŠ¨è®¾å¤‡
    Timeout:        30000,    // é»˜è®¤è¶…æ—¶ 30 ç§’
    SnifferTimeout: 10000,    // å—…æ¢è¶…æ—¶ 10 ç§’
    HeadTimeout:    5000,     // HEAD è¯·æ±‚è¶…æ—¶ 5 ç§’
    ConcurrencyNum: 3,        // å¹¶å‘æ•°
}
```

### ç¯å¢ƒå˜é‡

- `HOST`: æœåŠ¡å™¨ç›‘å¬åœ°å€ (é»˜è®¤: 0.0.0.0)

## ä¸ Node.js ç‰ˆæœ¬çš„å·®å¼‚

1. **æ€§èƒ½**: Golang ç‰ˆæœ¬åœ¨å¹¶å‘å¤„ç†å’Œå†…å­˜ä½¿ç”¨æ–¹é¢æ›´ä¼˜
2. **éƒ¨ç½²**: ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶æ›´å®¹æ˜“éƒ¨ç½²ï¼Œæ— éœ€ Node.js ç¯å¢ƒ
3. **ä¾èµ–**: ä½¿ç”¨ go-rod æ›¿ä»£ puppeteerï¼ŒåŠŸèƒ½åŸºæœ¬ä¸€è‡´
4. **API**: ä¿æŒä¸åŸç‰ˆ 100% å…¼å®¹çš„ API æ¥å£

## æ•…éšœæ’é™¤

### 1. Chrome æœªæ‰¾åˆ°

ç¡®ä¿ç³»ç»Ÿå·²å®‰è£… Chrome æµè§ˆå™¨ï¼Œæˆ–è€…è®¾ç½® `UseChrome: false` ä½¿ç”¨å†…ç½®æµè§ˆå™¨ã€‚

### 2. ç«¯å£è¢«å ç”¨

ä½¿ç”¨ `-port` å‚æ•°æŒ‡å®šå…¶ä»–ç«¯å£ï¼Œæˆ–è®©ç¨‹åºè‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨ç«¯å£ã€‚

### 3. è¶…æ—¶é—®é¢˜

æ ¹æ®ç›®æ ‡ç½‘ç«™çš„åŠ è½½é€Ÿåº¦è°ƒæ•´ `timeout` å‚æ•°ã€‚

### 4. å—…æ¢å¤±è´¥

- æ£€æŸ¥ç›®æ ‡ URL æ˜¯å¦å¯è®¿é—®
- å°è¯•ä½¿ç”¨è‡ªå®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
- æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šçš„è¯·æ±‚å¤´æˆ–è„šæœ¬

## å¼€å‘è¯´æ˜

### é¡¹ç›®ç»“æ„

```
golang/
â”œâ”€â”€ go.mod          # Go æ¨¡å—æ–‡ä»¶
â”œâ”€â”€ sniffer.go      # å—…æ¢å™¨æ ¸å¿ƒå®ç°
â”œâ”€â”€ server.go       # HTTP æœåŠ¡å™¨å®ç°
â””â”€â”€ README.md       # è¯´æ˜æ–‡æ¡£
```

### æ ¸å¿ƒç»„ä»¶

1. **Sniffer**: å—…æ¢å™¨æ ¸å¿ƒï¼ŒåŸºäº go-rod å®ç°
2. **Server**: HTTP æœåŠ¡å™¨ï¼ŒåŸºäº Gin æ¡†æ¶
3. **APIResponse**: ç»Ÿä¸€çš„å“åº”æ ¼å¼

## è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´çš„è®¸å¯è¯ã€‚